## é¡¹ç›®å®æˆ˜ï¼šå°†è´¹æ›¼ç‰©ç†è®²ä¹‰ç½‘é¡µåšæˆç”µå­ä¹¦



### é¡¹ç›®ç®€ä»‹

å…ˆå¤§è‡´è®²è®²é¡¹ç›®æƒ…å†µã€‚

![feynman_online](./img/feynman_online.png)

<img src="./img/change.JPG" alt="change" style="zoom:50%;" />

![latex](./img/latex.JPG)

![epub_black](./img/epub_black.JPG)

![epub_beautiful](./img/epub_beautiful.JPG)

åšå®Œé¡¹ç›®åï¼Œæœ‰ç‚¹å¼€å¿ƒã€‚å†™ä¸‹äº†è¿™æ ·ä¸€æ®µè¯ã€‚

å†™äº†ä¸€å¤©ä»£ç ï¼Œç»ˆäºå¾—åˆ°äº†æ¼‚äº®çš„è´¹æ›¼ç‰©ç†è®²ä¹‰ç”µå­ä¹¦ï¼è´¹æ›¼ç‰©ç†è®²ä¹‰å…¬å¼€åœ¨ç½‘ä¸Šï¼Œæ˜¯ç”¨`latex`æ¸²æŸ“çš„ã€‚äººä»¬å¸¸ç”¨`latex`æ¥å†™è®ºæ–‡ï¼Œå®ƒå¯¹æ•°å­¦å…¬å¼çš„æ¸²æŸ“å¾ˆæ£’ã€‚è€Œå…¬å¼€åœ¨ç½‘ä¸Šï¼Œç”¨åˆ°äº†`mathjax`è¿™ä¸ªåº“ã€‚å®ƒæŠŠ`latex`æºç å˜æˆäº†`html`ä»£ç ï¼Œç”Ÿæˆäº†å¾ˆå¤šçš„`div`å’Œ`span`æ ‡ç­¾ã€‚ç”µå­ä¹¦å´ä¸æ”¯æŒè¿™ç§æ–¹å¼ã€‚è¿™æ—¶ï¼Œæƒ³æ³•æ˜¯æŠ“å–ç½‘é¡µï¼Œé€†å‘`mathjax`æ¸²æŸ“ï¼Œæ¥ç€æ›¿æ¢æˆ`svg`å›¾ç‰‡ã€‚å‡ºç°äº†æŒºå¤šé—®é¢˜ï¼Œä¸€ä¸ªæ˜¯æºç æœ‰å¾ˆå¤šçš„`latex`è‡ªå®šä¹‰å®ï¼Œéœ€è¦åŠ ä¸Šï¼›ç¬¬äºŒä¸ªæ˜¯å†…åµŒå¾ˆå¤š`svg`ä¼šæœ‰é—®é¢˜ã€‚å¦‚æœæ˜¯å•ä¸ª`svg`å€’æ²¡é—®é¢˜ï¼Œå¾ˆå¤šçš„æ—¶å€™ä¼šå‡ºç°é—®é¢˜ã€‚å¤§æ¦‚æ˜¯æµè§ˆå™¨å’Œ`svg`çš„è¯¡å¼‚Bugã€‚è¿™æ—¶åªè¦æŠŠ`svg`ä¿å­˜ä¸ºæ–‡ä»¶ï¼Œç”¨`img`æ ‡ç­¾å¼•å…¥è¿›æ¥å³å¯ã€‚å…¬å¼ä¹Ÿåˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯æ–‡æœ¬ä¸­é—´çš„å…¬å¼ï¼Œä¸€ç§æ˜¯å•è¡Œçš„å…¬å¼ã€‚æ‰€ä»¥ï¼Œæœ€åå°±å¾—åˆ°äº†æ¼‚äº®çš„ç”µå­ä¹¦ï¼



### æŸ¥è¯¢çš„èµ„æ–™

è¿™é‡Œè®°å½•äº†è§£å†³é¡¹ç›®è¿‡ç¨‹ä¸­è®¿é—®çš„èµ„æ–™ã€‚å› ä¸ºè¿™æ˜¯ä¸€ä¸ªæ•™ç¨‹ï¼Œæ‰€ä»¥å‘å­¦ç”Ÿå±•ç¤ºä¸€ä¸‹å¤§æ¦‚åšä¸€ä¸ªé¡¹ç›®æ˜¯æ€ä¹ˆæ ·çš„ä½“éªŒã€‚

![](./img/s1.PNG)

![](./img/s2.PNG)

![](./img/s3.PNG)

![](./img/s4.PNG)

![](./img/s5.PNG)

![](./img/s6.PNG)

![](./img/s7.PNG)

![](./img/s8.PNG)



### å¼€å§‹é¡¹ç›®

è´¹æ›¼ç‰©ç†è®²ä¹‰å·²ç»åœ¨å…¬å¼€åœ¨ç½‘ä¸Šå¯ä»¥é˜…è¯»ã€‚æˆ‘æƒ³åœ¨`Kindle`ä¸Šçœ‹å®ƒã€‚ç„¶è€Œå› ä¸ºå®ƒæœ‰æŒºå¤šçš„æ•°å­¦å…¬å¼ã€‚å®ƒæœ€åˆçš„ç¨¿å­åº”è¯¥æ˜¯ç”¨`latex`åšçš„ã€‚å®ƒç”¨`mathjax`è¿™ä¸ªåº“æ¥æŠŠ`latex`æ ¼å¼çš„å†…å®¹æ˜¾ç¤ºåœ¨ç½‘é¡µä¸Šã€‚

ä¸¾ä¸ªä¾‹å­ã€‚

```html
<span class="MathJax_Preview" style="color: inherit; display: none;">
</span>
<div class="MathJax_Display">
    <span class="MathJax MathJax_FullWidth" id="MathJax-Element-10-Frame" tabindex="0" style="">
              <span class="mi" id="MathJax-Span-159" style="font-family: MathJax_Math-italic;">d<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;">
                </span>  
    </span>
</div>
<script type="math/tex; mode=display" id="MathJax-Element-10">\begin{equation}
\label{Eq:I:13:3}
dT/dt = Fv.
\end{equation}
</script>
```

ä¸Šé¢æ˜¯æˆªå–çš„ä¸€æ®µ`html`ä»£ç ã€‚è¿™ä¸€å—`html`ä»£ç ä¸­ã€‚`script`æ ‡ç­¾ä¸‹æ˜¯`latex`çš„åŸæ ·æ–‡æœ¬ã€‚`mathjax`æŠŠå®ƒå˜æˆå¾ˆå¤šçš„`span`ã€‚æ¥æ˜¾ç¤ºå®ƒã€‚

æˆ‘ä»¬ç°åœ¨æœ‰ä¸ªæ€è·¯ã€‚å°±æ˜¯æŠŠ`mathjax`çš„æ˜¾ç¤ºæ–¹æ³•æ”¹æˆ`svg`å›¾ç‰‡ã€‚

ä» GitHub ä¸Šæ‰¾åˆ°ä¸€ä¸ªé¡¹ç›®`tuxu/latex2svg`ã€‚

```python
from latex2svg import latex2svg
out = latex2svg(r'\( e^{i \pi} + 1 = 0 \)')
print(out['depth'])
print(out['svg'])
```

è¯•ç€è¿è¡Œï¼Œä½†å‡ºé”™äº†ã€‚

```shell
    raise RuntimeError('latex not found')
RuntimeError: latex not found
```

çœ‹çœ‹ä»£ç ã€‚

```python
    # Run LaTeX and create DVI file
    try:
        ret = subprocess.run(shlex.split(params['latex_cmd']+' code.tex'),
                             stdout=subprocess.PIPE, stderr=subprocess.PIPE,
                             cwd=working_directory)
        ret.check_returncode()
    except FileNotFoundError:
        raise RuntimeError('latex not found')
```

åŸæ¥è¿™ä¹Ÿä¾èµ–äº`latex`å‘½ä»¤ã€‚

å®‰è£…ä¸€ä¸‹ã€‚

```shell
brew install --cask mactex
==> Caveats
You must restart your terminal window for the installation of MacTex CLI tools to take effect.
Alternatively, Bash and Zsh users can run the command:
  eval "$(/usr/libexec/path_helper)"
==> Downloading http://mirror.ctan.org/systems/mac/mactex/mactex-20200407.pkg
==> Downloading from https://mirrors.aliyun.com/CTAN/systems/mac/mactex/mactex-20200407.pkg
######################################################################## 100.0%
All formula dependencies satisfied.
==> Installing Cask mactex
==> Running installer for mactex; your password may be necessary.
installer: Package name is MacTeX
installer: choices changes file '/private/tmp/choices20210315-4643-5884ro.xml' applied
installer: Installing at base path /
installer: The install was successful.
ğŸº  mactex was successfully installed!
```

å®‰è£…æˆåŠŸã€‚

```shell
% latex
This is pdfTeX, Version 3.14159265-2.6-1.40.21 (TeX Live 2020) (preloaded format=latex)
 restricted \write18 enabled.
**
```

```python
out = latex2svg(r'\( e^{i \pi} + 1 = 0 \)')
print(out['depth'])
print(out['svg'])

svg = open('1.svg', 'w')
svg.write(out['svg'])
svg.close()
```

å¯ä»¥ç”Ÿæˆ`svg`äº†ã€‚

æ‰€ä»¥è¯•è¯•æŠŠ`mathjax`ä¸­å¾—åˆ°çš„`latex`æ–‡æœ¬éƒ½ç”Ÿæˆä¸€ä¸‹ã€‚

```python
from bs4 import BeautifulSoup
from latex2svg import latex2svg

file = open('The Feynman Lectures on Physics Vol. I Ch. 13_ Work and Potential Energy (A).html')
content = file.read()

soup = BeautifulSoup(content)

mathjaxs = soup.findAll('script', {'type': 'math/tex'})
for mathjax in mathjaxs:
    print(mathjax.string)
    out = latex2svg(mathjax.string)
    print(out['svg'])
```

å¯æƒœå‡ºé”™äº†ã€‚

```python
    raise CalledProcessError(self.returncode, self.args, self.stdout,
subprocess.CalledProcessError: Command '['latex', '-interaction', 'nonstopmode', '-halt-on-error', 'code.tex']' returned non-zero exit status 1.
```

å…·ä½“å“ªä¸ªå…¬å¼é”™äº†å‘¢ã€‚

```latex
\tfrac{1}{2}mv^2
```



## latex

æ¥å­¦ä¹ ä¸€ä¸‹`latex`ã€‚

```latex
\documentclass[12pt]{article}
\usepackage{lingmacros}
\usepackage{tree-dvips}
\begin{document}

\section*{Notes for My Paper}

Don't forget to include examples of topicalization.
They look like this:

{\small
\enumsentence{Topicalization from sentential subject:\\ 
\shortex{7}{a John$_i$ [a & kltukl & [el & 
  {\bf l-}oltoir & er & ngii$_i$ & a Mary]]}
{ & {\bf R-}clear & {\sc comp} & 
  {\bf IR}.{\sc 3s}-love   & P & him & }
{John, (it's) clear that Mary loves (him).}}
}

\subsection*{How to handle topicalization}

I'll just assume a tree structure like (\ex{1}).

{\small
\enumsentence{Structure of A$'$ Projections:\\ [2ex]
\begin{tabular}[t]{cccc}
    & \node{i}{CP}\\ [2ex]
    \node{ii}{Spec} &   &\node{iii}{C$'$}\\ [2ex]
        &\node{iv}{C} & & \node{v}{SAgrP}
\end{tabular}
\nodeconnect{i}{ii}
\nodeconnect{i}{iii}
\nodeconnect{iii}{iv}
\nodeconnect{iii}{v}
}
}

\subsection*{Mood}

Mood changes when there is a topic, as well as when
there is WH-movement.  \emph{Irrealis} is the mood when
there is a non-subject topic or WH-phrase in Comp.
\emph{Realis} is the mood when there is a subject topic
or WH-phrase.

\end{document}
```

ç½‘ä¸Šæ‰¾åˆ°ä¸€æ®µæ ·ä¾‹çš„`latex`æºç ã€‚

```shell
% latex code.tex
This is pdfTeX, Version 3.14159265-2.6-1.40.21 (TeX Live 2020) (preloaded format=latex)
 restricted \write18 enabled.
entering extended mode
(./code.tex
LaTeX2e <2020-02-02> patch level 5
L3 programming layer <2020-03-06>
(/usr/local/texlive/2020/texmf-dist/tex/latex/base/article.cls
Document Class: article 2019/12/20 v1.4l Standard LaTeX document class
(/usr/local/texlive/2020/texmf-dist/tex/latex/base/size12.clo))
(/usr/local/texlive/2020/texmf-dist/tex/latex/tree-dvips/lingmacros.sty)
(/usr/local/texlive/2020/texmf-dist/tex/latex/tree-dvips/tree-dvips.sty
tree-dvips version .91 of May 16, 1995
) (/usr/local/texlive/2020/texmf-dist/tex/latex/l3backend/l3backend-dvips.def)
(./code.aux) [1] (./code.aux) )
Output written on code.dvi (1 page, 3416 bytes).
Transcript written on code.log.
```

![latex](./img/latex.png)

æ¥å¯¹ç€æºç å’Œæ¸²æŸ“åçš„æ•ˆæœï¼Œçœ‹çœ‹èƒ½å­¦åˆ°ä»€ä¹ˆã€‚

```latex
\begin{document}
\end{document}
```

è¿™æ ·æ¥æŠŠæ–‡æ¡£è£¹èµ·æ¥ã€‚

```latex
\section*{Notes for My Paper}
```

è¿™è¡¨ç¤º`section`æ ‡é¢˜å¼€å¤´ã€‚

```latex
\subsection*{How to handle topicalization}
```

è¿™è¡¨ç¤ºå­æ ‡é¢˜ã€‚

```latex
\shortex{7}{a John$_i$ [a & kltukl & [el & 
  {\bf l-}oltoir & er & ngii$_i$ & a Mary]]}
```

![shortex](./img/shortex.png)

å¯è§`$_i$`æ¥è¡¨ç¤ºä¸‹æ ‡ã€‚`{\bf l-}`æ¥è¡¨ç¤ºåŠ ç²—ã€‚

```latex
\enumsentence{Structure of A$'$ Projections:\\ [2ex]
\begin{tabular}[t]{cccc}
    & \node{i}{CP}\\ [2ex]
    \node{ii}{Spec} &   &\node{iii}{C$'$}\\ [2ex]
        &\node{iv}{C} & & \node{v}{SAgrP}
\end{tabular}
\nodeconnect{i}{ii}
\nodeconnect{i}{iii}
\nodeconnect{iii}{iv}
\nodeconnect{iii}{v}
}
```

<img src="./img/node.png" alt="node" style="zoom:50%;" />

æ³¨æ„åˆ°`nodeconnect`æ¥è¡¨ç¤ºè¿çº¿ã€‚



### latex è½¬æ¢æˆ svg

ç»§ç»­é¡¹ç›®ã€‚

```latex
\documentclass[16pt]{article}
\usepackage{amsmath}
\begin{document}

\[\tfrac{1}{2}mv^2\]

\end{document}
```

<img src="./img/frac.png" alt="frac" style="zoom:50%;" />

è¿™æ ·å¯ä»¥æ­£ç¡®åœ°è¢«æ¸²æŸ“ã€‚åœ¨ä»£ç é‡Œæ— æ³•è¢«æ¸²æŸ“ï¼Œå¯èƒ½æ˜¯å› ä¸ºæ²¡æœ‰åŠ ä¸Š`\usepackage{amsmath}`ã€‚

```latex
\documentclass[12pt,preview]{standalone}

\usepackage[utf8x]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{newtxtext}
\usepackage[libertine]{newtxmath}

\begin{document}
\begin{preview}
\tfrac{1}{2}mv^2
\end{preview}
\end{document}
```

```shell
! Missing $ inserted.
<inserted text>
                $
l.12 \tfrac{1}{2}
                 mv^2
```

è¿™æ ·å‡ºé”™äº†ã€‚è€Œæ”¹æˆä¸€ä¸‹è¿™æ ·å°±å¯ä»¥ã€‚

```latex
\[\tfrac{1}{2}mv^2\]
```

è¿›è¡Œå„ç§è¯•æ¢ã€‚

```python
from bs4 import BeautifulSoup
from latex2svg import latex2svg

file = open('The Feynman Lectures on Physics Vol. I Ch. 13_ Work and Potential Energy (A).html')
content = file.read()

soup = BeautifulSoup(content, features="lxml")

mathjaxs = soup.findAll('script', {'type': 'math/tex'})
for mathjax in mathjaxs:
    print(mathjax.string)
    wrap = '$' + mathjax.string + '$'
    # if 'frac' in mathjax.string:
    #     wrap = '$' + mathjax.string + '$'
    if 'FLP' in mathjax.string:
        continue
    elif 'Fig' in mathjax.string:
        continue
    elif 'eps' in mathjax.string:
        continue
    out = latex2svg(wrap)
    # print(out)
    node = BeautifulSoup(out['svg'], features="lxml")
    svg = node.find('svg')
    mathjax.insert_after(svg)
    # print(out['svg'])
    # break
    # mathjax.replaceWith(out['svg'])    
    
    # print(dir(mathjax))
    # break
    
    # out = latex2svg(wrap)    
    # print(out['svg'])

# print(len(soup.contents))
    
output_file = open('out.html', 'w')
output_file.write(soup.prettify())
output_file.close()
# print(soup.contents)

# out = latex2svg(r'\( e^{i \pi} + 1 = 0 \)')
# print(out['depth'])
# print(out['svg'])

# svg = open('1.svg', 'w')
# svg.write(out['svg'])
# svg.close()

```

è¿™äº›æˆ‘éƒ½åœ¨è¯•æ¢ä»€ä¹ˆå‘¢ã€‚

```python
    if 'FLP' in mathjax.string:
        continue
    elif 'Fig' in mathjax.string:
        continue
    elif 'eps' in mathjax.string:
        continue
```

è¿™é‡Œå½“è§£æåˆ°æœ‰`FLP`ã€`Fig`ã€`eps`åœ¨`latex`æºç çš„æ—¶å€™ï¼Œè½¬æ¢çš„è¿‡ç¨‹å‡ºé”™äº†ã€‚

ä¾‹å¦‚ï¼Œåœ¨`HTMLä¸­`ï¼Œæœ‰è¿™æ ·çš„è„šæœ¬ï¼š

```html
<script type="math/tex" id="MathJax-Element-11">\FLPF\cdot\FLPv</script>
```

è§£ææ‹¿åˆ°ï¼š

```latex
\FLPF\cdot\FLPv
```

å½“åœ¨ä»£ç é‡Œè½¬æ¢çš„æ—¶å€™å‡ºé”™äº†ã€‚ä¹Ÿå³ï¼Œ`latex2svg.py`å‡ºé”™äº†ã€‚è¿™é‡Œå°±æ˜¯ç”¨`latex`ç¨‹åºæ¥è½¬æ¢ã€‚

`code.tex`:

```latex
\documentclass[12pt,preview]{standalone}

\usepackage[utf8x]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{newtxtext}
\usepackage[libertine]{newtxmath}

\begin{document}
\begin{preview}
\begin{equation}
    \FLPF\cdot\FLPv
\end{equation}
\end{preview}
\end{document}
```

```shell
$latex code.tex
! Undefined control sequence.
l.13     \FLPF
              \cdot\FLPv
?
```

è¿™åˆ°åº•æ˜¯ä»€ä¹ˆé—®é¢˜ã€‚æˆ‘åæ¥æ‰æ³¨æ„åˆ°åœ¨`html`ä¸­çš„è¿™æ®µä»£ç ã€‚

```html
<script type="text/x-mathjax-config;executed=true">
      MathJax.Hub.Config({
        TeX: {
          Macros: {
            FLPvec: ["\\boldsymbol{#1}", 1], Figvec: ["\\mathbf{#1}", 1], FLPC: ["\\FLPvec{C}", 0], FLPF: ["\\FLPvec{F}", 0], FLPa: ["\\FLPvec{a}", 0], FLPb: ["\\FLPvec{b}", 0], FLPr: ["\\FLPvec{r}", 0], FLPs: ["\\FLPvec{s}", 0], FLPv: ["\\FLPvec{v}", 0], ddt: ["\\frac{d#1}{d#2}", 2], epsO: ["\\epsilon_0", 0], FigC: ["\\Figvec{C}", 0]
          }
        }
      });
</script>
```

è¿™è¡¨ç¤ºç½‘é¡µåœ¨æ¸²æŸ“çš„æ—¶å€™ï¼Œç»™`MathJax`è®¾ç½®ä¸Šäº†å®ã€‚æ‰€ä»¥æˆ‘ä»¬çš„`latex`è½¬æ¢æºç é‡Œä¹Ÿåº”è¯¥åŠ ä¸Šã€‚æ¥åŠ ä¸Šå®ƒä»¬ã€‚

```latex
\documentclass[12pt,preview]{standalone}

\usepackage[utf8x]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{newtxtext}
\usepackage[libertine]{newtxmath}

\newcommand{\FLPvec}[1]{\boldsymbol{#1}}
\newcommand{\Figvec}[1]{\mathbf{#1}}
\newcommand{\FLPC}{\FLPvec{C}}
\newcommand{\FLPF}{\FLPvec{F}}
\newcommand{\FLPa}{\FLPvec{a}}
\newcommand{\FLPb}{\FLPvec{a}}
\newcommand{\FLPr}{\FLPvec{r}}
\newcommand{\FLPs}{\FLPvec{s}}
\newcommand{\FLPv}{\FLPvec{v}}
\newcommand{\ddt}[2]{\frac{d#1}{d#2}}
\newcommand{\epsO}{\epsilon_0}
\newcommand{\FigC}{\Figvec{C}}


\begin{document}
\begin{preview}
\begin{equation}
    \FLPF\cdot\FLPv
\end{equation}
\end{preview}
\end{document}
```

è¿™æ ·å°±å¯¹äº†ã€‚

![fv1](./img/fv1.png)



### åˆ†æä»£ç 

æ¥çœ‹çœ‹æœ€åçš„ä»£ç ã€‚

```python
import subprocess
from bs4 import BeautifulSoup
from latex2svg import latex2svg

def clean_mathjax(soup, name, cls):
    previews = soup.findAll(name, {'class': cls})
    for preview in previews:
        preview.decompose()
        
def clean_script(soup):
    scripts = soup.findAll('script')
    for s in scripts:
        s.decompose()    

def wrap_latex(mathjax, equation = False):
    wrap = ''
    if equation:
        wrap = mathjax.string
    else:
        wrap = '$' + mathjax.string + '$'
    wrap = wrap.replace('label', 'tag')
    return wrap
 
def wrap_svg(svg, equation):
    if equation:
        p = BeautifulSoup(f'<div style="text-align:center;"></div>', features="lxml")
        p.div.append(svg)
        return p.div
    else:
        return svg

def to_svg(mathjaxs, equation=False):
    if equation:
        svg_prefix = 'eq_'
    else:
        svg_prefix = 'in_'
    i = 0
    for mathjax in mathjaxs:     
        print(mathjax.string)
        wrap = wrap_latex(mathjax, equation=equation)   
        out = {}
        try:
            out = latex2svg(wrap)   
        except subprocess.CalledProcessError as err:
            raise err      
            
        f = open(f'svgs/{svg_prefix}{i}.svg', 'w')
        f.write(out['svg'])
        f.close()
        
        node = BeautifulSoup('<img>', features="lxml")
        img = node.find('img')
        img.attrs['src'] = f'./svgs/{svg_prefix}{i}.svg'
        img.attrs['style'] = 'vertical-align: middle; margin: 0.5em 0;'
        
        p = wrap_svg(img, equation)
        mathjax.insert_after(p)
        i +=1

def main():    
    file = open('The Feynman Lectures on Physics Vol. I Ch. 13_ Work and Potential Energy (A).html')
    content = file.read()
    
    soup = BeautifulSoup(content, features="lxml")
    clean_mathjax(soup, 'span', 'MathJax')
    clean_mathjax(soup, 'div', 'MathJax_Display')
    clean_mathjax(soup, 'span', 'MathJax_Preview')
    
    mathjaxs = soup.findAll('script', {'type': 'math/tex'})
    to_svg(mathjaxs, equation=False)
    
    mathjaxs = soup.findAll('script', {'type': 'math/tex; mode=display'})   
    to_svg(mathjaxs, equation=True)
    
    clean_script(soup)
    
    output_file = open('out.html', 'w')
    output_file.write(soup.prettify())
    output_file.close()    

main()
```

å½“æˆ‘ä»¬æƒ³è½¬æ¢æ•´ä¸ªç”µå­ä¹¦æ—¶ï¼Œå¯ä»¥å…ˆç”¨ä¸€ä¸ªé¡µé¢æ¥è¯•è¯•ã€‚

```python
    file = open('The Feynman Lectures on Physics Vol. I Ch. 13_ Work and Potential Energy (A).html')
    content = file.read()
```

è¿™é‡Œä¾¿æ˜¯ä¸‹è½½äº†ä¸€ä¸ªé¡µé¢ã€‚

`MathJax`ç”Ÿæˆäº†å¾ˆå¤šçš„`div`å’Œ`span`ã€‚æ„æ€æ˜¯æ¯”å¦‚ `T+U=const`ã€‚MathJaxè¿™æ ·æ¥ç”Ÿæˆã€‚

```html
<span class="MathJax">T</span>
<span class="MathJax">+</span>
<span class="MathJax">U</span>
<span class="MathJax">=</span>
<span class="MathJax">const</span>
```

è¿™äº›å¾ˆè®¨åŒï¼Œä¹Ÿä¼šå½±å“æˆ‘ä»¬çš„æ–‡æœ¬ã€‚å› ä¸ºå·²ç»æœ‰`svg`äº†ï¼Œä¸éœ€è¦è¿™äº›äº†ã€‚

```python
def clean_mathjax(soup, name, cls):
    previews = soup.findAll(name, {'class': cls})
    for preview in previews:
        preview.decompose()

    clean_mathjax(soup, 'span', 'MathJax')
    clean_mathjax(soup, 'div', 'MathJax_Display')
    clean_mathjax(soup, 'span', 'MathJax_Preview')
```

æŠŠå®ƒä»¬éƒ½å»æ‰ã€‚

```python
    mathjaxs = soup.findAll('script', {'type': 'math/tex'})
    to_svg(mathjaxs, equation=False)
    
    mathjaxs = soup.findAll('script', {'type': 'math/tex; mode=display'})   
    to_svg(mathjaxs, equation=True)
```

æ³¨æ„åˆ°è¿™é‡Œåˆ†æˆä¸¤ç§çš„`script`ã€‚

```latex
m(dv/dt)=F
```

è¿™æ˜¯å†…åµŒå½¢å¼çš„ã€‚

```latex
\begin{equation}
\underset{\text{K.E.}}{\tfrac{1}{2}mv^2}+
\underset{\text{P.E.}}{\vphantom{\tfrac{1}{2}}mgh}=\text{const},\notag
```

è¿™æ˜¯æˆæ®µå½¢å¼çš„ã€‚

å½“æ—¶å†…åµŒå½¢å¼æ—¶ï¼Œè½¬æ¢è¦åœ¨è¡¨è¾¾å¼å·¦å³åŠ ä¸Š`$`æˆ–`[]`ã€‚å¦åˆ™å°±æœ‰å¯èƒ½å‡ºé”™ã€‚

```latex
\begin{document}
\begin{preview}
\tfrac{1}{2}mv^2
\end{preview}
\end{document}
```

```shell
! Missing $ inserted.
<inserted text>
                $
l.26 \tfrac{1}{2}
                 mv^2
```

å¾—æ”¹æˆè¿™æ ·ï¼š

```latex
\begin{document}
\begin{preview}
$\tfrac{1}{2}mv^2$
\end{preview}
\end{document}
```

æ¥ä¸‹æ¥çœ‹çœ‹å¦‚ä½•è½¬æ¢`latex`æˆ`svg`ã€‚

```python
    if equation:
        svg_prefix = 'eq_'
    else:
        svg_prefix = 'in_'
```

```shell
% tree svgs
svgs
â”œâ”€â”€ eq_0.svg
â”œâ”€â”€ eq_1.svg
â”œâ”€â”€ in_0.svg
```

è¿™æ ·æ¥ä¿å­˜`svg`ã€‚

```python
def wrap_latex(mathjax, equation = False):
    wrap = ''
    if equation:
        wrap = mathjax.string
    else:
        wrap = '$' + mathjax.string + '$'
    wrap = wrap.replace('label', 'tag')
    return wrap
```

è¿™é‡Œæ¥å¯¹`latex`æºç è¿›è¡Œä¸€äº›è°ƒæ•´ã€‚æ³¨æ„åˆ°`label`å˜æˆäº†`tag`ã€‚

![tag](./img/tag.png)

æ³¨æ„å³è¾¹çš„`(Eq:I:13:14)`ã€‚å¦‚æœæ˜¯`label`çš„è¯ï¼Œåˆ™æ²¡è§£ææˆåŠŸã€‚è¿™ä¼šæ˜¾ç¤ºçš„æ˜¯`(1)`ã€‚è¿™é‡Œå°†å°±ç”¨`tag`è¡¨ç¤ºä¸€ä¸‹ï¼Œæš‚æ—¶æ²¡æœ‰æ·±ç©¶ã€‚

æ¥ç€å°±è¿›è¡Œè°ƒç”¨`latex2svg.py`ã€‚

```python
        out = {}
        try:
            out = latex2svg(wrap)   
        except subprocess.CalledProcessError as err:
            raise err    
```

çœ‹çœ‹`latex2svg.py`ã€‚

```python
    # Run LaTeX and create DVI file
    try:
        ret = subprocess.run(shlex.split(params['latex_cmd']+' code.tex'),
                             stdout=subprocess.PIPE, stderr=subprocess.PIPE,
                             cwd=working_directory)
        ret.check_returncode()
    except FileNotFoundError:
        raise RuntimeError('latex not found')
```

è¿™é‡Œæ˜¯åœ¨è°ƒç”¨`latex`å‘½ä»¤ã€‚

```shell
 % latex --help
Usage: pdftex [OPTION]... [TEXNAME[.tex]] [COMMANDS]
   or: pdftex [OPTION]... \FIRST-LINE
   or: pdftex [OPTION]... &FMT ARGS
  Run pdfTeX on TEXNAME, usually creating TEXNAME.pdf.
```

```python
    try:
        ret = subprocess.run(shlex.split(params['dvisvgm_cmd']+' code.dvi'),
                             stdout=subprocess.PIPE, stderr=subprocess.PIPE,
                             cwd=working_directory, env=env)
        ret.check_returncode()
    except FileNotFoundError:
        raise RuntimeError('dvisvgm not found')
```

è¿™é‡Œæ˜¯åœ¨è°ƒç”¨`dvisvgm`å‘½ä»¤ã€‚

```shell
% dvisvgm
dvisvgm 2.9.1

This program converts DVI files, as created by TeX/LaTeX, as well as
EPS and PDF files to the XML-based scalable vector graphics format SVG.

Usage: dvisvgm [options] dvifile
       dvisvgm --eps [options] epsfile
       dvisvgm --pdf [options] pdffile
```

ä¸Šé¢è¯´çš„`latex`è‡ªå®šä¹‰å®å†™åœ¨å“ªå„¿å‘¢ã€‚è¿™é‡Œè¦æ”¹ä¸€ä¸‹`latex2svg.py`ã€‚æ”¹æ”¹`default_preamble`ã€‚

```python
default_preamble = r"""
\usepackage[utf8x]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{newtxtext}
\usepackage[libertine]{newtxmath}

\newcommand{\FLPvec}[1]{\boldsymbol{#1}}
\newcommand{\Figvec}[1]{\mathbf{#1}}
\newcommand{\FLPC}{\FLPvec{C}}
\newcommand{\FLPF}{\FLPvec{F}}
\newcommand{\FLPa}{\FLPvec{a}}
\newcommand{\FLPb}{\FLPvec{a}}
\newcommand{\FLPr}{\FLPvec{r}}
\newcommand{\FLPs}{\FLPvec{s}}
\newcommand{\FLPv}{\FLPvec{v}}
\newcommand{\ddt}[2]{\frac{d#1}{d#2}}
\newcommand{\epsO}{\epsilon_0}
\newcommand{\FigC}{\Figvec{C}}
"""
```

è½¬æ¢æˆåŠŸåï¼Œå†™å…¥åˆ°æ–‡ä»¶ã€‚

```python
        f = open(f'svgs/{svg_prefix}{i}.svg', 'w')
        f.write(out['svg'])
        f.close()
```

ç»§ç»­ã€‚

```python
        node = BeautifulSoup('<img>', features="lxml")
        img = node.find('img')
        img.attrs['src'] = f'./svgs/{svg_prefix}{i}.svg'
        img.attrs['style'] = 'vertical-align: middle; margin: 0.5em 0;'
```

è¿™é‡Œæ„é€ ä¸€ä¸ª`img`æ ‡ç­¾ã€‚

```python
def wrap_svg(svg, equation):
    if equation:
        p = BeautifulSoup(f'<div style="text-align:center;"></div>', features="lxml")
        p.div.append(svg)
        return p.div
    else:
        return svg
      
p = wrap_svg(img, equation)
```

å¦‚æœæ˜¯ç‹¬æ®µçš„`latex`ï¼Œé‚£ä¹ˆç”¨`div`åŒ…èµ·æ¥ï¼Œå¹¶ä¸”å±…ä¸­ã€‚

```python
mathjax.insert_after(p)
```

è¿™é‡ŒæŠŠ`div`æ ‡ç­¾æˆ–`img`æ ‡ç­¾åŠ åœ¨åŸæ¥çš„`script`åé¢ã€‚

```python
def clean_script(soup):
    scripts = soup.findAll('script')
    for s in scripts:
        s.decompose()    
        
clean_script(soup)
```

æŠŠæ‰€æœ‰çš„`latex`æ›¿æ¢å®Œ`svg`åï¼Œå°±ä¸éœ€è¦`script`äº†ã€‚æŠŠå®ƒä»¬åˆ æ‰ï¼Œè¿™æ ·æ•´æ´ä¸€ç‚¹ã€‚

æœ€åï¼Œå†å†™å…¥æŠŠä¿®æ”¹åçš„æ•´ä¸ª`html`å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶é‡Œã€‚

```python
    output_file = open('out.html', 'w')
    output_file.write(soup.prettify())
    output_file.close()    
```

æ¥ç€ç”¨`pandoc`å·¥å…·ï¼Œè½¬æ¢æˆ`epub`ã€‚

```shell
pandoc -s -r html out.html -o feynman.epub
```

è¿™ä¼šæ‰“å¼€ï¼Œå°±æ˜¯æ¼‚äº®çš„ç”µå­ä¹¦äº†ã€‚

ä¸ºä»€ä¹ˆä¸ç›´æ¥åµŒå…¥`svg`æ ‡ç­¾ï¼Œè€Œæ˜¯ç”¨`img`æ¥å¼•å…¥å‘¢ã€‚å³æ˜¯è¯´è¿™æ ·å†™ï¼š

```html
<p></p>
<svg></svg>
<p></p>
```

æœ‰ä¸ªå¾ˆå¥‡æ€ªçš„`bug`ã€‚å½“æœ‰å¾ˆå¤šçš„`svg`çš„æ—¶å€™ï¼Œä¼šå‡ºç°è¿™æ ·çš„æƒ…å†µã€‚

<img src="./img/svg_p1.png" alt="svg_p1" style="zoom:40%;" />

åæ¥å‘ç°ç”¨`img`å¼•å…¥å°±è¡Œã€‚è‡³äºä¸ºä»€ä¹ˆè¿™æ ·ï¼Œæ²¡ææ˜ç™½ã€‚å½“æˆ‘æŠŠè¿™å•ä¸ªçš„`svg`æ‹¿å‡ºæ¥çš„æ—¶å€™ï¼Œç”¨æµè§ˆå™¨çœ‹å°±æ²¡æœ‰é—®é¢˜ã€‚çœ‹æ¥æ˜¯åœ¨æµè§ˆå™¨æ¸²æŸ“éå¸¸å¤šä¸ª`svg`æ—¶ï¼Œå°±ä¼šå‡ºé”™ã€‚



### æœ€å

è‡³äº`epub`å¦‚ä½•è½¬æˆ`mobi`ï¼Œå¯ä»¥ç”¨`Kindle`çš„å®˜æ–¹å·¥å…·`Kindle Previewer 3`ã€‚æ³¨æ„è¿™é‡Œåªæ˜¯ä¸€ç« ã€‚

è¯¥é¡¹ç›®ä»£ç åœ¨[feynman-lectures-mobi@lzwjava](https://github.com/lzwjava/feynman-lectures-mobi)ã€‚

å¦‚ä½•æŠŠæ‰€æœ‰çš„é¡µé¢éƒ½æŠ“å–æ•´ç†æˆç”µå­ä¹¦å‘¢ã€‚åç»­å†è®²ã€‚ä½†è¿™è´¹æ›¼ç‰©ç†è®²ä¹‰ä¸€ç« ä¹Ÿå¤Ÿçœ‹çš„äº†ã€‚å¥½äº†ï¼Œè®©æˆ‘ä»¬æ‹¿èµ·Kindleå¼€å§‹çœ‹å§ã€‚

